# Default to w_latest if no tag is passed
ARG CENTOS_VER=7
ARG PRODUCT=lsst_distrib
ARG TAG=w_latest
ARG LSST_TAG=${CENTOS_VER}-stack-${PRODUCT}-${TAG}

FROM lsstsqre/centos:${LSST_TAG}

ARG LSST_TAG
LABEL MAINTAINER="Leanne Guy <leanne@lsst.org>"

USER root

## Install a more recent version of git
#RUN yum -y install git && \
#    yum -y clean all  && \
#    rm -rf /var/cache

# Load minimal LSST environment in /etc/profile.d (is this needed?)
# COPY setup_lsst.sh /etc/profile.d/setup_lsst.sh
RUN echo "# load the minimal LSST environment" >>  /etc/profile.d/setup_lsst.bash && \
    echo "source /opt/lsst/software/stack/loadLSST.bash" >>  /etc/profile.d/setup_lsst.bash \
RUN cp /opt/lsst/software/stack/loadLSST.bash  /etc/profile.d/setup_lsst.sh

USER lsst
WORKDIR /home/lsst

# Set the env
# echo "$ENV_VAR
# TODO: update to load from autogenerated lsst.env file
ENV PYTHONPATH=/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cp_verify/g371fd4ad0f+981361f536/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/dustmaps_cachedata/g41a3ec361e+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/faro/gc9d0b822c4+c77192796b/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/fgcm/g93e57c359b/lib/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/fgcmcal/g5158719beb+d3bd4248f3/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/validate_drp/geb381f050f+3e2a4edf39/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cp_pipe/gd956fcaf32+534e76423b/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/display_matplotlib/gbdd1c81305+e12e3daa67/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/display_firefly/gd2200cecb0+e12e3daa67/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ap_verify/g6ac9416187+726e1d294f/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/jointcal/g0f5d30203d+799f78b33f/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cbp/gaebe1cbaf0+e12e3daa67/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_subaru/gfe5147f876+9faca4c1ea/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_lsst/g56cc523ee0+fcead46afe/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_cfht/g2b6e816441+9dea9d01cd/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_pool/g6ea9deef35+4b12cfabe8/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pipe_drivers/g8b6839f0a4+27ef25b588/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_gaap/g3ff5e6c3ea+3f23f6fe5b/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_shapeHSM/gfbfb15d729+2f0f08c812/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_photometryKron/g235fec5482+2f0f08c812/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_convolved/ge96dbbe9aa+accb469737/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_bps/g7f186c6df2+c6f06ced65/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_mpexec/g80d878e12a+e63ba569b4/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_orca/g56b4a02df4+4a94b8817b/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_execute/g21dfb85fb4+7ce148d724/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_piff/g9647d74750+2f0f08c812/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/display_ds9/gfaaac7f73f+e12e3daa67/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_simpleShape/g20ef201b66+f5fc6c176e/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_decam/ged5f728255+9a916e8e3d/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/alert_packet/g6179d27fb4/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ap_association/g773f254f10+a4fad1eed3/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ap_pipe/gbf04329a6e+48032457b0/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/verify_metrics/g80d799c5c9+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/dax_apdb/gd4f24f6172+463c0bb41e/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/verify/g6c14bf9b21+0a89c3b0a0/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ip_diffim/g5706f010af+bdbf389b49/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ip_isr/g9cb75138f3+2f0f08c812/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_astrom/g28e8fc4f0a+2f0f08c812/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/kht/g14ffe67dc2+fe93bf5141/cpp/build:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_trailedSources/geebf31c2e0+f5fc6c176e/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/psfex/g57437a15a7+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_psfex/g0683b0d77a+4d990ac55c/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/scarlet_extensions/g9d18589735+64a50c43f9/lib/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/proxmin/g79c0498783/lib/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/scarlet/gb4b49c695e+f31336177f/lib/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_scarlet/ga4198d173c+a461bd98c9/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pipe_tasks/gec3662e80e+a146e0ac48/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/shapelet/gd79a88f3f0+e12e3daa67/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_modelfit/g8cdf404ddd+a141786114/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_test/g26fc4c0ca3+d83ab177f1/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/astro_metadata_translator/gfc6a95e243+0ec44a33f5/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_base/gc5bf9196b6+8930bbf9a1/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pipe_base/g205747afb7+6a6b7caf78/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/coadd_utils/g8ea0215d90+4b12cfabe8/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/resources/g04ba59dc9d+e455c7a49c/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_butler/g679b36c395+4441abb2a7/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/skymap/gd542723d9a+6a6b7caf78/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_base/gd28f579bee+2d8375a739/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_algorithms/gbe01a4569f+c282027174/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/astshim/g545b398f03+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/sphgeom/gfb2c8f9998+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/geom/gd4e50c7800+59995c006e/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pex_config/g9e4416f923+0ec44a33f5/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/log/gd27fc4addd+e455c7a49c/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_persistence/g6a31054a6e+07bca8c8ac/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pex_exceptions/g958458c828+19c07f3325/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/sconsUtils/gb7d2e96037/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/base/gc17f1a8c7d+f3d053c481/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cpputils/g1ffd6c4751+5f4f369930/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/utils/g517bd563f7+fe49bdc73c/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_base/g68429ac19b+e455c7a49c/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/afw/g5c39d4753b+2b91704afc/python:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_deblender/g359a236c20+3ffb0ee7c7/python:/opt/lsst/software/stack/conda/miniconda3-py38_4.9.2/envs/lsst-scipipe-0.7.0/eups/python
ENV PATH=/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/faro/gc9d0b822c4+c77192796b/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/fgcm/g93e57c359b/scripts:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/fgcmcal/g5158719beb+d3bd4248f3/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/validate_drp/geb381f050f+3e2a4edf39/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cp_pipe/gd956fcaf32+534e76423b/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ap_verify/g6ac9416187+726e1d294f/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/jointcal/g0f5d30203d+799f78b33f/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_subaru/gfe5147f876+9faca4c1ea/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_lsst/g56cc523ee0+fcead46afe/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_cfht/g2b6e816441+9dea9d01cd/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_pool/g6ea9deef35+4b12cfabe8/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pipe_drivers/g8b6839f0a4+27ef25b588/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_bps/g7f186c6df2+c6f06ced65/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_mpexec/g80d878e12a+e63ba569b4/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_orca/g56b4a02df4+4a94b8817b/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ctrl_execute/g21dfb85fb4+7ce148d724/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_decam/ged5f728255+9a916e8e3d/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/alert_packet/g6179d27fb4/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ap_pipe/gbf04329a6e+48032457b0/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/dax_apdb/gd4f24f6172+463c0bb41e/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/verify/g6c14bf9b21+0a89c3b0a0/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ip_isr/g9cb75138f3+2f0f08c812/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_astrom/g28e8fc4f0a+2f0f08c812/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/psfex/g57437a15a7+f3d053c481/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_psfex/g0683b0d77a+4d990ac55c/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pipe_tasks/gec3662e80e+a146e0ac48/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_modelfit/g8cdf404ddd+a141786114/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/astro_metadata_translator/gfc6a95e243+0ec44a33f5/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_base/gc5bf9196b6+8930bbf9a1/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_butler/g679b36c395+4441abb2a7/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_base/gd28f579bee+2d8375a739/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_algorithms/gbe01a4569f+c282027174/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pex_config/g9e4416f923+0ec44a33f5/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/sconsUtils/gb7d2e96037/bin:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/afw/g5c39d4753b+2b91704afc/bin:/opt/lsst/software/stack/conda/miniconda3-py38_4.9.2/envs/lsst-scipipe-0.7.0/eups/bin:/opt/lsst/software/stack/conda/miniconda3-py38_4.9.2/envs/lsst-scipipe-0.7.0/bin:/opt/lsst/software/stack/conda/miniconda3-py38_4.9.2/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/lsst/.local/bin:/home/lsst/bin
ENV LD_LIBRARY_PATH=/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cp_pipe/gd956fcaf32+534e76423b/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/jointcal_cholmod/gaea3fc0611+f3d053c481/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/jointcal/g0f5d30203d+799f78b33f/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/obs_subaru/gfe5147f876+9faca4c1ea/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_shapeHSM/gfbfb15d729+2f0f08c812/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_photometryKron/g235fec5482+2f0f08c812/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_piff/g9647d74750+2f0f08c812/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_simpleShape/g20ef201b66+f5fc6c176e/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ip_diffim/g5706f010af+bdbf389b49/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/ip_isr/g9cb75138f3+2f0f08c812/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_astrom/g28e8fc4f0a+2f0f08c812/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_trailedSources/geebf31c2e0+f5fc6c176e/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/psfex/g57437a15a7+f3d053c481/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_extensions_psfex/g0683b0d77a+4d990ac55c/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/shapelet/gd79a88f3f0+e12e3daa67/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_modelfit/g8cdf404ddd+a141786114/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/coadd_utils/g8ea0215d90+4b12cfabe8/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_base/gd28f579bee+2d8375a739/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_algorithms/gbe01a4569f+c282027174/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/astshim/g545b398f03+f3d053c481/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/sphgeom/gfb2c8f9998+f3d053c481/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/geom/gd4e50c7800+59995c006e/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pex_config/g9e4416f923+0ec44a33f5/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/log/gd27fc4addd+e455c7a49c/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_persistence/g6a31054a6e+07bca8c8ac/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/pex_exceptions/g958458c828+19c07f3325/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/base/gc17f1a8c7d+f3d053c481/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/cpputils/g1ffd6c4751+5f4f369930/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/daf_base/g68429ac19b+e455c7a49c/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/afw/g5c39d4753b+2b91704afc/lib:/opt/lsst/software/stack/stack/miniconda3-py38_4.9.2-0.7.0/Linux64/meas_deblender/g359a236c20+3ffb0ee7c7/lib
ENV CONDA_PYTHON_EXE=/opt/lsst/software/stack/conda/miniconda3-py38_4.9.2/bin/python

# Update the user bashrc file to setup the LSST environment on login
COPY --chown=lsst:lsst --chmod=755 setup_lsst.sh /home/lsst/setup_lsst.sh
RUN echo ". setup_lsst.sh" >>  /home/lsst/.bashrc && \
    source /home/lsst/.bashrc

# Extract the lsst environment variables
COPY --chown=lsst:lsst --chmod=755 env_lsst.py /home/lsst/env_lsst.py
RUN $CONDA_PYTHON_EXE /home/lsst/env_lsst.py --filename /home/lsst/lsst.env

# Additional packages to install (move to requirements file)
RUN pip install python-dotenv mkinit

# Update init.py on all eups managed packages (not sure if needed - hopefully not)
#COPY --chown=lsst:lsst --chmod=755 mkinit_lsst.py /home/lsst/mkinit_lsst.py
#RUN $CONDA_PYTHON_EXE /home/lsst/mkinit_lsst.py

# Run a bash login shell as default
CMD ["/bin/bash", "-l"]